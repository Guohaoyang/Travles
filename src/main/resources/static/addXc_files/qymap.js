define(function(){var e=jQuery,n={};return n=function(){this.mapDivId="",this.map="",this.coordinates=[],this.bounds=[],this.markers=[],this.lables=[],this.infowindows=[],this.flightPath=[],this.openedWindow=[],this.searchTimer=0},n.prototype={initMap:function(e,n){var o,t=39.92,a=116.46;""!=n&&"object"==typeof n&&(t=n.lat,a=n.lng),o=new google.maps.LatLng(t,a);var i={maxZoom:19,zoom:3,center:o,mapTypeControl:!0,scaleControl:!0,mapTypeControlOptions:{position:google.maps.ControlPosition.TOP_RIGHT},zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_TOP},panControl:!1,streetViewControl:!1,mapTypeId:google.maps.MapTypeId.ROADMAP};this.mapDivId=e,this.map=new google.maps.Map(document.getElementById(this.mapDivId),i)},formatMarkerData:function(n){var o=0,t=this,a={},i=[],r=[],s=[];return e.each(n,function(e,n){if(n.lat&&n.lng&&(0!=n.lat||0!=n.lng)){var p=new google.maps.LatLng(n.lat,n.lng);r.push(p),s.push(p),t.bounds.push(p);var l=n.lat+"_"+n.lng;a[l]||(a[l]=1,n.name=n.name||"",n.__HTML__=n.__HTML__||"",i.push({latlng:p,position:o,title:n.name,__HTML__:n.__HTML__,id:n.id,subdata:n}))}o+=1}),this.coordinates=s,{markers:i,bounds:r,coordinates:s}},formatFlightPathData:function(n,o){var t,a=[],i={path:n,strokeColor:"#FF0000",strokeOpacity:.5,strokeWeight:5};return i=e.extend(i,o),t=new google.maps.Polyline(i),a.push(t),a},removeMarker:function(n){var o,t=this,a=t.getLastOpenedInfoWindow();o="undefined"!=typeof n?n:t.markers,e.each(o,function(e,n){if(a>0&&n.infowindow&&n.infowindow.__qyerid__==a)return!0;if(n.lableMarker)try{n.lableMarker.onRemove()}catch(o){}n.setMap(null)})},removeFlightPath:function(n){var o,t=this;o="undefined"!=typeof n?n:t.flightPath,e.each(o,function(e,n){n&&n.setMap(null)})},drawSelfLableMarker:function(o,t){var a=this,i=[];return e.each(o,function(e,o){var r=new n.LableMarker(a.map,o,t);i.push(r)}),a.lables=i,i},removeSelfLableMarker:function(n){var o=this;n=n||o.lables,e.each(n,function(e,n){n.onRemove()})},getOpenedInfoWinMarker:function(){var n=this,o="",t=n.getLastOpenedInfoWindow();return e.each(n.markers,function(e,n){n.infowindow&&n.infowindow.__qyerid__==t&&(o=n)}),o},getLastOpenedInfoWindow:function(){var e=0;return""!=this.openedWindow&&(e=this.openedWindow[0],e=e.__qyerid__),e},removeInfoWindowMarker:function(e){if(e.lableMarker)try{e.lableMarker.onRemove()}catch(n){}e.setMap(null),this.openedWindow=[]},drawMarker:function(o,t,a){var i=this,r=[];markerJson={},markerSize=o.length,c={showInfoWindow:1,showLableMarker:!0,lableConfig:{}},c=e.extend(c,t);var s=i.getLastOpenedInfoWindow();return e.each(o,function(o,t){!function(o,a,p){var l=null,d="",u=99999;if(s>0&&s==t.id)return l=i.getOpenedInfoWinMarker(),i.markers.push(l),r.push(l),markerJson[a.id]=l,!0;d="function"==typeof p.getMapIconCb?p.getMapIconCb:i.getMapIcon,l=new google.maps.Marker({position:a.latlng,map:i.map,title:a.title,icon:d(markerSize,a.position,a.subdata)}),u="undefined"!=typeof p["z-index"]?p["z-index"]:u,l.setZIndex(u),"function"==typeof p.markerHoverCb&&p.markerHoverCb(l,a);var g=p.showInfoWindow&&a&&""!=a.__HTML__?!0:!1;if(p.showLableMarker){var c=new n.LableMarker(i.map,a,p.lableConfig,g);l.lableMarker=c}if(g){var h=new google.maps.InfoWindow({content:'<div style="width:255px;">'+a.__HTML__+"</div>"});h.__qyerid__=a.id,l.infowindow=h}google.maps.event.addListener(l,"click",function(){"function"==typeof p.markerClickCb&&p.markerClickCb(l,a),g&&(i.openedWindow&&(e.each(i.openedWindow,function(e,n){n.close()}),i.openedWindow=[]),h.open(i.map,l),i.infowindows.push(h),i.openedWindow.push(h))}),g&&google.maps.event.addListener(l,"closeclick",function(){h.close()}),i.markers.push(l),r.push(l),markerJson[a.id]=l}(o,t,c)}),"undefined"!=typeof a&&"json"==a?markerJson:r},drawPolyLine:function(n){var o=this;e.each(n,function(e,n){n.setMap(o.map),o.flightPath.push(n)})},fitBounds:function(n){var o=new google.maps.LatLngBounds;e.each(n,function(e,n){o.extend(n)}),this.map.fitBounds(o)},getBounds:function(){return this.map.getBounds()},getMapIcon:function(e,n,o){var t,a,i,r="";return t=new google.maps.Point(0,32*n),a=new google.maps.Size(27,32),i="https://static.qyer.com/images/plan2/p_2_2/map_ico.png",r=new google.maps.MarkerImage(i,e,t)},bindMapMoveEvent:function(e){var n=this;google.maps.event.addListener(n.map,"idle",function(){"function"==typeof e&&(n.searchTimer>0&&clearTimeout(this.searchTimer),n.searchTimer=setTimeout(e,10))})},bindBoundsChanged:function(e){var n=this;google.maps.event.addListener(n.map,"bounds_changed",function(){"function"==typeof e&&e()})},setCenterPos:function(e,n){newCenter=new google.maps.LatLng(e,n),this.map.panTo(newCenter)},moveCenterPos:function(n,o){function t(e,n){this.point=n,this.setMap(e)}var a,i=this,r=this.map.getCenter();t.prototype=new google.maps.OverlayView,t.prototype.draw=function(){return!1},t.prototype.onAdd=function(){var e,n=this.getProjection();return e=n.fromContainerPixelToLatLng(this.point)};var s,p,l;l=new google.maps.Point(800,150),p=new t(i.map,l),s=p.onAdd();var d="undefined"!=typeof o?o:this.coordinates,u="",g="";e.each(d,function(e,n){var o=n.lng();""==u&&(u=o,g=o),u>o&&(u=o),o>g&&(g=o)});var a,c=s.lng()-u,h=r.lng()-c,m=this.map.getBounds();m.getNorthEast();a=new google.maps.LatLng(r.lat(),h),this.map.panTo(a);var f=this.map.getBounds(),w=(f.getSouthWest(),f.getNorthEast());g+c>w.lng()&&w.lng()>0&&this.map.setZoom(this.map.getZoom()-1)},decodePath:function(e){return google.maps.geometry.encoding.decodePath(e)}},n.pixelToLat=function(e,n){var o=2*Math.PI*(1-e/(128<<n)),t=Math.pow(Math.E,o),a=(t-1)/(t+1);return 180*Math.asin(a)/Math.PI},n.latToPixel=function(e,n){var o,t;return o=Math.sin(e*Math.PI/180),t=Math.log((1+o)/(1-o)),128*Math.pow(2,n)*(1-t/(2*Math.PI))},n.lngToPixel=function(e,n){return(e+180)*(256*Math.pow(2,n))/360},n.pixelToLng=function(e,n){return 360*e/(256*Math.pow(2,n))-180},n.toggleBounce=function(e){null!=e.getAnimation()?e.setAnimation(null):e.setAnimation(google.maps.Animation.BOUNCE)},n.mapLoadIsOk=!1,n.LableMarker="",n.loadGoogleMap=function(o){n.mapLoadIsOk?o():(window.googleMapCbFun=function(){requirejs(["web_old_map_labelmarker"],function(e){n.LableMarker=e,o()})},e.getScript("http://maps.google.cn/maps/api/js?v=3.30&libraries=geometry&sensor=false&key=AIzaSyCFyj9mrzuoTWACoSqRy77qYr9i8O6gi9s&callback=googleMapCbFun"))},n});
