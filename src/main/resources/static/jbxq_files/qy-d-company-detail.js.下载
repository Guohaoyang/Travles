var CommentList=Backbone.Model.extend({defaults:{}}),commentList=new CommentList,CommentLists=Backbone.Collection.extend({model:CommentList,url:"/comment/getCommentByPost"}),CommentView=Backbone.View.extend({el:$(".each-all-comments"),template:_.template($("#postCommentsTemp").html()),render:function(t){t.toJSON().data||this.$el.append(this.template({tempComment:t.toJSON()}))},initialize:function(){this.collection.on("add change",this.render,this),this.on("unshift",this.insetM,this)},insetM:function(t){this.$el.prepend(this.template({tempComment:t}))},events:{"click .sed-dialog":"showDialog","click .sed-publish":"publish","click .sed-cancel, .sed-statusComment.link-open":"cancelPub","click .link-del-sed":"linkDel","click .link-edit-sed":"linkEdit","click .sed-donate.added":"donate","click .sed-statusComment.link-close":"comment","click .sed-statusComment.link-open":"hideComment","click .link-report":"reportComment"},comment:function(t){$(t.currentTarget).addClass("link-open").removeClass("link-close");var e=$(t.currentTarget).parents(".each-comment-list").find(".sed-comment-wrp");e.find(".edui-default").length?e.show():$.qy.newEditor(e.find(".sed-comment").prop("id"),$.qy.smEditorWrp||"sed",function(){e.show()}),$(t.currentTarget).parents(".each-comment-list").find(".forward-home").removeClass("hidden")},donate:function(t){var e=$(t.currentTarget);e.attr("data-postsId");if(!$.qy.user||!$.qy.user.id)return validateLogin(),!1;e.html("已赞").addClass("removed").removeClass("added")},cancelPub:function(t){var e=$(t.currentTarget).parents(".each-comment-list"),n=e.find(".sed-comment-wrp");e.find(".status-content").show().find(".sed-statusComment").removeClass("link-open").addClass("link-close"),n.removeClass("go-top").hide().attr("data-isedit",!1)},publish:function(a){var s=$(a.currentTarget),i=this,m=s.parents(".open-comment").find(".edui-default").attr("id"),t=$("#btnPublish"),d=$.qy.commentEditor[m].getPlainTxt(),e=s.prevAll(".forward-home").find('input[type="checkbox"]').prop("checked");if(!$.qy.user||!$.qy.user.id)return validateLogin(),!1;for(var n=s.attr("data-postsId"),r={},o=0,c=$.qy.gCommentL.models.length;o<c;o++)if($.qy.gCommentL.models[o].toJSON().comment_id==n){(r=$.extend({},$.qy.gCommentL.models[o].toJSON())).obj_id=n;break}var l=s.parents(".each-comment-list").find(".sed-comment-wrp"),u="true"==l.attr("data-isedit")?"/comment/update":"/comment/add";d=d.replace(/<a.*?(?:>|\/>)|<\/a>/gi,"");var p=(d=$.qy.setNet(d)).replace(/<img\ssrc="\/static\/lib.*?>/gi,"$#"),f={content:$.trim(d),parent_comment_id:n,pid:t.attr("data-postsId")||s.parents("li.publish").attr("data-id")||s.parents("li.publish").attr("data-qaid"),host_type:s.attr("data-product-type"),root_pId:t.attr("data-refPId"),xsrf_token:$.getCookie("qy_xsrf_cookie")};if(l.attr("data-isedit")&&(f=$.extend({},f,{cid:l.attr("data-cid")})),e){var h=$.qy.setErem(d);f=$.extend({},f,{summary:h})}$.ajax({type:"post",url:u,data:f,beforeSend:function(){return $.trim(d)?600<$.trim(p).length?($.message({msg:"评论最长不能超过600字"}),!1):void 0:($.message({msg:"内容不能为空"}),!1)},success:function(t){if("1"==t.status)if($.qy.commentEditor[m].setContent(""),"true"==s.parents(".each-comment-list").find(".sed-comment-wrp").attr("data-isedit"))s.parents(".each-comment-list").find(".detail").first().html(d),i.cancelPub(a);else{var e={};e.usermini=$.qy.user.usermini,e.user_id=$.qy.user.id,e.user_name=$.qy.user.name,e.content=d,e.time=t.data.commentDate,e.comment_id=t.data.cid,e.product_type=f.host_type,e.parent=r,$.qy.showSempleComments&&(e.parent.type=CommonConst.COMMENT_PARENT_TYPE_COMMENT),e.donateQty=0,e.dialogFlag=!1,e.cannotRef=!0,e.parent.type=CommonConst.COMMENT_PARENT_TYPE_COMMENT,$.qy.gCommentL.unshift(e,{silent:!0});var n=$.qy.gCommentV.template({tempComment:$.qy.gCommentL.models[0].toJSON()});s.parents(".comment-list").prepend(n),$.qy.commentEditor[m].setContent(""),s.parents(".each-comment-list").find(".ops .sed-statusComment").trigger("click");var o=s.parents(".comment-list").prev(".all-coment-title").find(".qty");o.html(parseInt(o.html())+1),$("#operater .qty").html(parseInt($("#operater .qty").html())+1)}else $.message({msg:t.other.desc||"操作失败"})}})},linkEdit:function(t){var e=$(t.currentTarget),n=e.attr("data-postsId");if(!$.qy.user||!$.qy.user.id)return validateLogin(),!1;var o=e.parents(".each-comment-list"),a=$.trim(o.find(".status-content .detail").html());a=a.replace(/<a.*?(?:>|\/>)|<\/a>/gi,"");var s=o.find(".sed-comment-wrp"),i=s.find(".sed-comment").prop("id");o.find(".status-content").hide(),s.find(".edui-default").length?$.qy.commentEditor[i].setContent(a):$.qy.newEditor(i,$.qy.smEditorWrp||"sed",function(){$.qy.commentEditor[i].setContent(a)}),o.find(".forward-home").addClass("hidden"),s.addClass("go-top").show().attr({"data-isedit":!0,"data-cid":n})},linkDel:function(t){var n=$(t.currentTarget),o=n.attr("data-postsId"),a=this;if(!$.qy.user||!$.qy.user.id)return validateLogin(),!1;var e={xsrf_token:$.getCookie("qy_xsrf_cookie")},s="/comment/delete",i="get";n.hasClass("comment-auth")?(e.cid=o,e.host_type=n.attr("data-product-type")||CommonConst.PRODUCT_TYPE_COMPANY):(s="/comment/deleteByPost",e.cid=o,e.pid=n.attr("data-refPost"),e.host_type=n.attr("data-product-type")||CommonConst.PRODUCT_TYPE_COMPANY,i="post"),$.window({fillText:$("#confirmDelTemp").html(),title:"确认删除",addclass:"wid-msg"}),console.log(e),$(".m-wid .btn-confirm").on("click",function(){$.ajax({type:i,data:e,url:s,success:function(t){if("1"==t.status){var e=n.parents(".comment-list").prev(".all-coment-title").find(".qty");e.html(parseInt(e.html())-1),$("#operater .qty").html(parseInt($("#operater .qty").html())-1),a.collection.remove(a.collection.get(o)),n.parents(".each-comment-list").remove(),$(".m-wid .btn-confirm").off("click"),$.window.close()}else $.window.close(),$.message({msg:t.other.desc||"操作失败"})}})})},reportComment:function(t){var n=$(t.currentTarget);if(!$.qy.user||!$.qy.user.id)return validateLogin(),!1;$.window({fillText:$("#reportTemp").html(),title:"举报评论",addclass:"wid-msg"}),$(".m-wid .reason-box").on("click",".radio",function(){"0"==$(this).find("input").attr("value")?$(".reason-box").find("textarea").removeClass("hidden"):$(".reason-box").find("textarea").addClass("hidden")}),$(".m-wid .btn-confirm").on("click",function(){if(!$.qy.user||!$.qy.user.id)return validateLogin(),!1;var t=n.attr("data-product-type"),e={object_id:n.attr("data-commentid"),object_type:CommonConst.CONTENT_TYPE_PRODUCT_CMT,object_vertical_type:t,rel_object_id:n.attr("data-postid"),from_uid:$.qy.user.id,to_uid:n.attr("data-userid"),reason_type:$('[name="reason_type"]:checked').val(),comment:$.trim($(".reason-box textarea").val()),xsrf_token:$.getCookie("qy_xsrf_cookie")};$.ajax({type:"post",url:"/user/report",data:e,beforeSend:function(){return e.reason_type==CommonConst.REPORT_REASON_OTHER&&""==e.comment?($.message({msg:"请填写举报理由"}),!1):e.reason_type==CommonConst.REPORT_REASON_OTHER&&25<e.comment.length?($.message({msg:"举报理由不能超过25个字"}),!1):void 0},success:function(t){"1"==t.status?($.window.close(),$.window({fillText:$("#reportSuccessModal").html(),title:"举报成功",addclass:"wid-msg"})):$.message({msg:t.other.desc||"发布失败"})}})})}});$.qy.viewModel=$.extend(!0,{comment:{m:CommentLists,v:CommentView,mm:CommentList}});var pathArr=window.location.pathname.split("/"),cId=pathArr[pathArr.length-1],showComments=function(){var s=new $.qy.viewModel.comment.m,t=new $.qy.viewModel.comment.v({collection:s,el:$("#commentList")});$.qy.gCommentV=t,$.qy.gCommentL=s;var i=$("#commentList");s.fetch({data:{id:cId,host_type:CommonConst.PRODUCT_TYPE_COMPANY},beforeSend:function(){i.loading(!0)},success:function(t,e){if("1"==e.status){var a=i.attr("data-cuid");if(e.data&&0<e.data.length){$(".all-coment-title .qty").html(e.other.total_num);for(var n=0,o=e.data.length;n<o;n++)e.data[n].post_id=cId,e.data[n].cannotRef=!0,a!=$.qy.user.id&&e.data[n].user_id==a&&(e.data[n].isCompanyAuth=!0);s.add(e.data),e.other&&0<e.other.total_num&&$("#commentPage").pagination(e.other.total_num,{items_per_page:20,callback:function(t){s.fetch({data:{startidx:20*t,id:cId,host_type:CommonConst.PRODUCT_TYPE_COMPANY},beforeSend:function(){i.loading(!0)},success:function(t,e){if($(".each-comment-list",i).remove(),s.shift(),e.data&&0<e.data.length){for(var n=0,o=e.data.length;n<o;n++)e.data[n].post_id=cId,e.data[n].cannotRef=!0,a!=$.qy.user.id&&e.data[n].user_id==a&&(e.data[n].isCompanyAuth=!0);s.add(e.data)}else $(".each-comment-list",i).remove()},complete:function(){i.loading(!1)}})}})}$.qy.initGetInfo()}else $(".each-comment-list",i).remove()},complete:function(){i.loading(!1)}})},submitComment=function(){$("#btnPublish").on("click",function(){if(!$.qy.user||!$.qy.user.id)return validateLogin(),!1;var o=$(this),a=$.qy.commentEditor.postDetailTxt.getContent();$.ajax({type:"post",url:"/comment/add",data:{content:$.trim(a),pid:cId,host_type:CommonConst.PRODUCT_TYPE_COMPANY,xsrf_token:$.getCookie("qy_xsrf_cookie")},beforeSend:function(){if(!a)return $.message({msg:"内容不能为空"}),!1},success:function(t){if("1"==t.status){$.qy.commentEditor.postDetailTxt.setContent("");var e={};e.usermini=$.qy.user.usermini,e.user_id=$.qy.user.id,e.user_name=$.qy.user.name,e.content=a,e.time=t.data.commentDate,e.comment_id=t.data.cid,e.parent={},e.donateQty=0,e.dialogFlag=!1,e.cannotRef=!0,e.product_type=1,$.qy.gCommentL.unshift(e,{silent:!0}),$.qy.gCommentV.trigger("unshift",e);var n=o.parents(".open-comment").next(".each-all-comments").find(" .all-coment-title .qty");n.html(parseInt(n.html())+1)}else $.message({msg:t.other.desc||"发布失败"})}})})},listNum=4,showCompanySquare=function(){$.ajax({type:"get",url:"/company/getCompanySquare?num=1",success:function(t){"1"==t.status&&0<t.data.length&&t.data[0].company_id!=cId&&($("#companyAccess").removeClass("hidden"),$("#companyAccess .list-header").after('<a target="_blank" href="/company" rel="nofollow" class="company-list"><img src="'+t.data[0].postcover+'"><p class="company-title">'+t.data[0].title+"</p></a>"))}})},getCompanyList=function(t){$.ajax({url:"/company/getCompanyList",type:"get",data:{object_id:cId,object_type:CommonConst.COMPANY_REQ_TYPE_COMPANY,loop:1,num:listNum,startidx:t},success:function(t){if("1"==t.status&&t.data&&0<t.data.length){t.other&&($(".total-num").text(t.other.total_num),t.other.total_num<=4&&$(".get-other").addClass("hidden")),$("#qyCompanyList").empty().parents(".m-h-list").removeClass("hidden");for(var e=0;e<t.data.length;e++){var n='<li><a target="_blank" href="/company/'+t.data[e].company_id+'"><img src="'+t.data[e].postcover+'"><p>'+t.data[e].title+"</p></a></li>";$("#qyCompanyList").append(n)}}}})},showOtherCompany=function(){var t=0;$(".get-other").on("click",function(){getCompanyList(t+=listNum)})},abortCompany=function(){$(".abort-company").on("click",function(){if(!$.qy.user||!$.qy.user.id)return validateLogin(),!1;$.window({fillText:$("#confirmAbortTemp").html(),title:"撤回确认",addclass:"wid-msg"}),$(".m-wid .btn-confirm").on("click",function(){$.ajax({url:"/company/abortCompany",type:"post",data:{xsrf_token:$.getCookie("qy_xsrf_cookie"),company_id:cId},success:function(t){"1"==t.status?($.window.close(),$.message({msg:"撤销成功"}),setTimeout(function(){location.reload()},2e3)):$.message({msg:t.other.desc})}})})})},sendToauth=function(){$(".send-to-auth").on("click",function(){if(!$.qy.user||!$.qy.user.id)return validateLogin(),!1;$("#modal2InboxTemp").show();var o=$("#modal2InboxTemp .inbox-content").prop("id");$("#modal2InboxTemp").find(".edui-default").length||$.qy.newEditor(o,"letterL"),$(".m-wid").undelegate(".btn-confirm","click").delegate(".btn-confirm","click",function(){var t=$.qy.commentEditor[o].getPlainTxt(),e=$("#sendUser"),n=$("#modalTips");t=t.replace(/<a.*?(?:>|\/>)|<\/a>/gi,""),t=$.qy.setNet(t),$.trim(t)?$.ajax({type:"post",url:"/inbox/sendInbox",data:{content:t,to_user_id:e.find("span").attr("data-id"),xsrf_token:$.getCookie("qy_xsrf_cookie")},beforeSend:function(){return $.trim(t)?600<$.trim(t).length?($.message({msg:"私信最长不能超过600个字。"}),!1):void 0:($.message({msg:"内容不能为空"}),!1)},success:function(t){"1"==t.status?($.message({msg:"发送成功！"}),$.qy.commentEditor[o].setContent(""),$("#modal2InboxTemp").hide()):$.message({msg:t.other.desc||"发送失败"})}}):n.html("请填写反馈内容。").show()}),$("#modal2InboxTemp").find(".btn-close,.btn-cancel").on("click",function(){$("#modal2InboxTemp").hide(),$.qy.commentEditor[o].setContent("")})})};$(function(){$.qy.newEditor("postDetailTxt","wdXXL"),$.qy.smEditorWrp="wdXL",showComments(),submitComment(),showCompanySquare(),abortCompany(),sendToauth(),showOtherCompany()});