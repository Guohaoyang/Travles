Request=Class.refactor(Request,{initialize:function(a){a.eraseWhichOne=a.hasOwnProperty("eraseWhichOne")?Boolean(a.eraseWhichOne):true;this.previous(a)},success:function(b,a){if(this.options.eraseWhichOne){b=daodao.erasePrependedWhileOne(b)}this.previous(b,a)}});(function(a){if(typeof a!="function"){return}JSON.decode=function(b,c){b=daodao.erasePrependedWhileOne(b);return a(b,c)}})(JSON.decode);
var daodao=daodao||{};daodao.call=function(f,h,c){if(h==null){return false}var d=new Event(h||window.event);if(!c){c=d.target}c=ta.id(c);if(!c){return false}var a=arguments;var b=Array.from(a).slice(3);b.splice(0,0,d,c);try{b.unshift({evt:d});b.unshift(f);return ta.run.apply(null,b)}catch(g){ta.util.error.record(g,"daodao.call - "+f,h)}return false};daodao.addClass=function(c,a,b){a.addClass(b)};daodao.removeClass=function(c,a,b){a.removeClass(b)};daodao.openNewWindow=function(){var b=700;var a=550;var d=(window.getHeight()-a)/2;var c=(window.getWidth()-b)/2;windowObj=window.open("","connect_window","height="+a+", width="+b+", toolbar=no, menubar=no, scrollbars=no, resizable=no, top="+d+", left="+c+", location=no, status=no");return windowObj};daodao.actionRecord=function(c,b,a){new Request({url:"/ActionRecord?action="+a}).send()};daodao.pageAction=function(c,d){var a;switch(typeOf(c)){case"string":a=c.trim();break;case"element":var b=Type.isString(d)?("data-"+d+"-action"):"data-action";a=$(c).get(b);if(a){a=a.trim()}break;default:a=""}if(a.length>0){daodao.actionRecord(null,null,a)}};daodao.isLogined=function(){return Cookie.exist("TAForumSub2")};daodao.waitForCondition=function(d,c,b,a){if(a==null){a=3}if(d()){c()}else{if(a>=0){setTimeout(function(){daodao.waitForCondition(d,c,b,a-1)},b)}}};daodao.waitForSelector=function(b,d,c,a){daodao.waitForCondition(function(){return $$(b).length>0},d,c,a)};daodao.registerRedirect=function(d,c,b){var a=ta.registration.register(c,b);if(a&&d){d()}};if(ta&&ta.analytics&&ta.analytics._insertGAScriptElement){ta.analytics._insertGAScriptElement=function(){try{var c=document.createElement("script");c.type="text/javascript";c.async=true;c.src=("https:"==document.location.protocol?"https://":"http://")+"stats.g.doubleclick.net/dc.js";var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(c,a)}catch(b){_errorRecord(b,"loading ga.js problem")}}}if(!("stringify" in JSON)){JSON.stringify=JSON.encode}daodao.erasePrependedWhileOne=function(a){if(typeof a==="string"){a=a.replace(/^\s*while\(1\);\s*/,"")}return a};
var daodao=daodao||{};daodao.CityFlyoutOverlay=new Class({Implements:[Options,Events],options:{type:"HOTEL",activate:"CLICK",geoIdElement:null,geoNameElement:null,alignElement:null,trackingContinent:null,PYPTGeoListPopupType:null},initialize:function(c,b){this.setOptions(b);var f=this;var a=(f.options.geoIdElement&&f.options.geoNameElement)?"overlay-cityflyout":"overlay-cityflyout overlay-cityflyout-plain";var e=null;var d=null;switch(f.options.activate){case"HOVER":e=ta.overlays.ACTIVATE_HOVER;d="mouseenter";break;default:e=ta.overlays.ACTIVATE_CLICK;d="click"}f.overlayObj=new ta.overlays.RelativeOverlayBelow({style:a,autoShow:false,showCloseButton:true,keepElementInDocument:true,flipPadding:0,activate:e,below:true,onShow:function(){f.reposition()},onHide:function(){}},$(c));f.overlayContainer=f.overlayObj.container;$(c).addEvent(d,f.loadData.bind(f))},loadData:function(){var b=this;var a="";switch(this.options.type){case"FORUM":a="/apages/geo/forum.html";break;case"TOURISM":a="/apages/geo/tourism.html";break;case"ATTRACTION":a="/apages/geo/attraction.html";break;case"EATERY":a="/apages/geo/restaurant.html";break;case"DEAL":a="/apages/geo/deal.html";break;case"PYPT_CITY_FLY_OUT":a="/apages/geo/PYPT_city_fly_out.html";break;default:a="/apages/geo/hotel.html"}new Request({url:a,method:"get",onRequest:function(){b.overlayObj.inner.setContent('<p class="loading">加载中，请稍候...</p>')},onSuccess:function(c){b.overlayObj.inner.setContent(c);b.bindCityTabview();b.bindCityLink();if(b.options.PYPTGeoListPopupType){daodao.pageAction(b.options.PYPTGeoListPopupType+"_geo_list")}},onFailure:function(){b.overlayObj.inner.setContent('<p class="failed">失败了，请稍候再试...</p>')}}).send()},bindCityTabview:function(){var b=this.options.trackingContinent;var d=this.options.PYPTGeoListPopupType;var f=this.overlayContainer;var e=f.getElement(".overlay-cityflyout-header h3");var a=f.getElements(".overlay-cityflyout-tabnav li");var c=f.getElements(".overlay-cityflyout-tabcontent div");a.forEach(function(h,g){h.addEvent("click",function(i){i.preventDefault();a.removeClass("selected");a[g].addClass("selected");c.hide();c[g].show();if(!d){e.set("html",a[g].get("title"))}if(d&&b){daodao.pageAction(b[g])}})})},bindCityLink:function(){var c=this;var b=this.overlayContainer;var a=b.getElements(".overlay-cityflyout-tabcontent a");a.addEvent("click",function(f){if(c.options.geoIdElement&&c.options.geoNameElement){f.preventDefault();c.options.geoIdElement.set("value",$(this).getAttribute("geoid"));c.options.geoNameElement.set("value",$(this).get("html"));c.fireEvent("onSelect",[$(this).getAttribute("geoid"),$(this).get("html")]);c.overlayObj.hide();if(c.options.PYPTGeoListPopupType){ta.store("typeahead.isFromDDPYPTCityFlyout",true);daodao.pageAction(c.options.PYPTGeoListPopupType+"_geoId_"+c.options.geoIdElement.get("value"));ta.pages.home.logAndAct("select",c.options.PYPTGeoListPopupType,"","PTPT","","",$(this).getAttribute("geoid"),"","",null,"Choose_from_destination_list_"+c.options.geoNameElement.get("value"));var d=function(h,g){var i=ta.id(g+"_geo-city");var j=ta.id(g);if(j!==null&&j.value==c.options.geoNameElement.value){j.focus();j.setAttribute("name","");j.removeClass("focusClear")}};d("hotel search-input","hotelSearch_loc_handler");d("attraction search-input","attractionSearch_loc_handler");d("restaurant search-input","restaurantSearch_loc_handler");d("destination search-input","destinationSearch_loc_handler");d("header-search-input search-input","restaurants_lander_loc_handler");d("header-search-input search-input","hotels_lander_loc_handler");d("header-search-input search-input","attractions_lander_loc_handler");d("header-search-input search-input","destinations_lander_loc_handler");$$(".typeahead-container").hide();var e=ta.id("hotelSearch").getElement(".date_picker");if(e&&!ta.retrieve("date.picker.pageInDate")){f.stopPropagation();e.getParent().focus()}}}})},reposition:function(){var c=this;if(c.options.alignElement){var b=c.options.alignElement.getSize();var a=c.options.alignElement.getPosition();c.overlayContainer.style.left=a.x+"px";c.overlayContainer.style.top=a.y+b.y+"px"}},hide:function(){this.overlayContainer.hide()},show:function(){this.overlayContainer.show()},destroy:function(){_this.overlayObj=null}});daodao.CityFlyoutOverlayFactory={createCityFlytoutWithPrefix:function(a,c){if(a==null){a=""}var b=new daodao.CityFlyoutOverlay($("cityflyout-"+a+"button"),{type:$("cityflyout"+a).getAttribute("data-type"),alignElement:$("cityflyout"+a),geoIdElement:$("cityflyout-"+a+"geoid"),geoNameElement:$("cityflyout-"+a+"cityname")});if(c){b.addEvent("onSelect",c)}}};
(function(){var a=true,e=null;function c(){var g=e.getElements(".overlay-cityflyout-tabnav li");var f=e.getElements(".overlay-cityflyout-tabcontent div");g.forEach(function(i,h){i.addEvent("click",function(j){j.preventDefault();g.removeClass("selected");g[h].addClass("selected");f.hide();f[h].show()})})}function b(){var f=$("masthead-tourism-links");new Request({url:"/apages/geo/tourism.html",method:"get",onRequest:function(){f.set("html",'<p><img style="margin-right:5px;" src="/ddimg/loading/grey18x19.gif"/>加载中，请稍候...</p>')},onSuccess:function(g){g=g.replace(/href=\"\/Tourism/g,'onclick="setPID(32332)" href="/Tourism');f.set("html",g);e.getElements(".overlay-cityflyout-header span").dispose();c();e.removeEvent("mouseover",d)},onFailure:function(){a=true;tourism_box.set("html","<p>失败了，请稍候再试...</p>")}}).send()}function d(f){if(a){a=false;b()}}$(document).addEvent("domready",function(){e=$$(".tabsBar-redesign .cityName")[0];if(e!=undefined&&!e.hasClass("notNarrowGeo")){e.addEvent("mouseover",d)}})})();
daodao.followOverlayInit=function(b,a){if(typeOf(a)!="element"){return false}new ta.overlays.RelativeOverlayBelow({style:"dropMenu",innerDivClass:"inner noPad",width:300,below:true,autoShow:true,yoffset:5,waitForCss:true,activate:ta.overlays.ACTIVATE_HOVER,remoteContent:"/apages/top_followus.html",onShow:function(){daodao.pageAction("top_follow_overlay_open")}},a);a.onmouseover=null};
var updateSessionData=(function(c,a,b){return function(k,d,h){var j,f;var e=k?k:"";f={inDay:$("qcInDay_"+e),inMonth:$("qcInMonth_"+e),outDay:$("qcOutDay_"+e),outMonth:$("qcOutMonth_"+e)};var g=true,i={};Object.each(f,function(m,l){if(typeOf(m)!=="null"&&m.value){i[l]=m.value.replace("/"," ")}else{g=false;return false}});j=ta.widgets.calendar.getPageAdultsCount();if(g){i.adults=ta.widgets.calendar.getPageAdultsCount();new Request({url:"/UpdateSessionDatesAjax",data:Object.toQueryString(i),method:"post",onSuccess:function(){if(d){setTimeout(function(){d(h)},10)}}}).send()}}})();var dd=dd||{};dd.overlays=dd.overlays||{};dd.overlays.init=function(){if(!ta.overlays||!ta.overlays.Factory){return}var a=ta.overlays.Factory;a.createPairedCalendar=function(e,c,b){var d=ta.overlays.createPairedCalendar(e,c,b);d.addEvent("onUpdate",function(){if(this.form.name=="HAC_FORM_mastheadNav"){updateSessionData("headertabs")}else{if(this.form.name=="HAC_FORM_sidebar"){updateSessionData("sidebar")}else{if(this.form.name=="HAC_FORM_1"||this.form.name=="HAC_SEARCH_FORM"){updateSessionData()}}}});return d};a.createPairedCalendarGeo=function(d,c,b){if(d){new Event(d).preventDefault()}new ta.overlays.PairedCalendar(c,{validate:true,onUpdate:ta.commerce.checkrates.showProviders.bind(ta.commerce.checkrates)});ta.commerce.checkrates.geoId=b};a.loadPCROverlay=function(){try{var d=ta.id("CHECK_RATE");if(!d||(d.getPosition().y==0&&ta.id("COM_HVY_CR_BTN"))){d=ta.id("COM_HVY_CR_BTN")}if(ta.has("meta.isHackathonBC")&&(ta.has("meta.session_dates")||ta.widgets.calendar.hasPageDates())){d=ta.id("MetaRatesContent")||d}var j=ta.id("PERSISTENT_CHECK_RATES_CONTENT");var k=window.getScroll();if(!j){return}var c=j.hasClass("closeTest");if(!d||!k){j.dispose();return}ta.store("pcr.scrollPoint",d.getPosition().y);if(!k){return}ta.store("pcr.initialYPos",window.getScroll().y);var f=j.get("html");j.dispose();var h="persistentCR";if(ta.retrieve("checkrates.meta_ui_post_click_prices")){if(ta.retrieve("checkrates.pcr_classic_styling_on_meta")){h=h+" classicOnMeta"}else{h=h+" miniMetaPCR"}}var b="sprite-greenX";var g=new ta.overlays.AbsoluteOverlay({toWindow:false,autoShow:false,positionType:"fixed",permanent:true,zIndex:"9996",style:h,content:f,closeButtonClass:b,closeLink:"<div>"+ta.commerce.checkrates.pcrCloseTxt+"</div>",onClose:function(){try{if(ta.retrieve("wechat_overlay")){ta.retrieve("wechat_overlay").hide()}ta.store("pcr.keepHidden",true);Cookie.writeSession("CPCR",1);new Request({url:"/ActionRecord?action=persistent_cr_close"}).send()}catch(l){ta.util.error.record(l,"pcr - onClose")}}});ta.store("pcr.overlay",g);window.removeEvent("scroll",ta.overlays.Factory.loadPCROverlay);window.addEvent("scroll",ta.commerce.checkrates.positionCheckRates)}catch(i){window.removeEvent("scroll",ta.overlays.Factory.loadPCROverlay);ta.util.error.record(i,"pcr - scroll init");return false}};a.relRightRemoteHLB_CommCopy=function(d,b){if(d||window.event){new Event(d||window.event).preventDefault()}b=ta.id(b);var c=_findRemoteURI(b);if(c==null){return}b.onmouseover=null;new ta.overlays.RelativeOverlayRight({activate:ta.overlays.ACTIVATE_HOVER,pinnable:ta.overlays.PINNABLE_CLICK,backdrop:ta.overlays.BACKDROP_PINNED,style:"commerceOverlay rgba_flyout",showCloseButton:true,onLoad:function(){if(ta.meta&&ta.meta.update){ta.meta.update.updateCRForm("_pop")}else{ta.commerce.checkrates.updateCRForm("_pop")}}},b)};a.ddCityFlyout=function(c,b){new daodao.CityFlyoutOverlay(c,b)};a.ddPYPTCityFlyout=function(b,c,e,d){new daodao.PYPTGeoListPopUp(b,c,e,d)}};
(function(){if(dd&&dd.overlays&&dd.overlays.init){dd.overlays.init()}})();
(function(){var a={validateUrlReg:/^(?:https?|\/).+/,appendQuery:function(d,c,f){if(!a.validateUrl(d)){return d}var e=[],g=d.split("#"),d=g[0].trim();e.push(d);e.push(d.indexOf("?")>-1?"&":"?");e.push(c);e.push("=");e.push(f);if(g.length>1){e.push("#");e.push(g[1].trim())}return e.join("")},validateUrl:function(c){return a.validateUrlReg.test(c)}};var b={init:function(){b.trackPID("PAGE");b.trackClick("PAGE");b.trackHover("PAGE")},trackPID:function(c){var e=$(c)||$(document),d=/^(?:https?|\/).+/;e.addEvent("click:relay(a[data-pid])",function(){if(this.retrieve("PID-initialized")){return}var f=Number(this.get("data-pid")),g=this.get("href");if(f>0){this.set("href",a.appendQuery(g,"pid",f))}this.store("PID-initialized",true)})},trackClick:function(c){var d=$(c)||$(document);d.addEvent("click:relay([data-action-click])",function(){b.actionRecord($(this).get("data-action-click"))})},trackHover:function(c){var d=$(c)||$(document);d.addEvent("mouseenter:relay([data-action-hover])",function(){b.actionRecord($(this).get("data-action-hover"))})},actionRecord:function(c){new Request({url:"/ActionRecord",method:"get",data:{action:c}}).send()}};$(document).addEvent("domready",function(){b.init()})})();
(function(c){var b="/CnServerSideCookie";var a=new Class({Binds:["hide"],initialize:function(d){if(!d){return}this.container=d;this.pageProperty=this.container.get("data-property");this.closeBtn=ta.select(".close-btn",this.container);this.smoothAnimation=!Browser.ie||Browser.version>=10;this.initAnimation();this.show();this.closeBtn.addEvent("click",this.hide)},initAnimation:function(){if(this.smoothAnimation){var d="bottom 300ms linear";this.container.setStyles({transition:d,"-webkit-transition":d,"-moz-transition":d})}else{this.animator=new Fx.Tween(this.container,{duration:300,property:"bottom",link:"cancel",unix:"px"})}},hide:function(d){var e=this.container.getHeight();var f=d.target.get("data-name");if(this.smoothAnimation){this.container.setStyle("bottom","-"+e+"px")}else{this.animator.start(null,"-"+e)}ta.setEvtCookie(this.pageProperty,"MQ_close",crPageServlet,0,b);new ta.util.ajax({url:b,data:{set:f,value:true,token:JS_SECURITY_TOKEN}})},show:function(){if(this.smoothAnimation){this.container.setStyle("bottom","0px")}else{this.animator.start(null,0)}}});window.addEvent("load",function(){var d=ta.id("footer_survey");if(d){new a(d)}})})();
