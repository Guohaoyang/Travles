daodao.PYPTCityFlyoutOverlay=new Class({Extends:daodao.CityFlyoutOverlay,bindCityLink:function(){var a=this,c=a.options,b=c.geoIdElement,d=c.geoNameElement;if(!Type.isElement(b)||!Type.isElement(d)){return}this.overlayContainer.addEvent("click:relay(.overlay-cityflyout-tabcontent a)",function(g){g.stop();var e=$(this),f=e.get("geoid"),h=e.get("text");b.set("value",f);d.set("value",h);a.fireEvent("select",[f,h]);a.overlayObj.hide();daodao.pageAction(this)})},show:function(){this.parent.apply(this,arguments);this.fireEvent("show")}});daodao.PYPTGeoListPopUp=function(j,b,e,a){var f=false;var h=ta.id(b);var d=ta.id(j);if(d){var i={hotelSearch_loc_handler:"PYPT-hotel",attractionSearch_loc_handler:"PYPT-attr",restaurantSearch_loc_handler:"PYPT-eat",destinationSearch_loc_handler:"PYPT-dest",restaurants_lander_loc_handler:"Restaurants_lander",hotels_lander_loc_handler:"Hotels_lander",attractions_lander_loc_handler:"Attractions_lander",destinations_lander_loc_handler:"Destinations_lander"};trackingContinentPrefix=function(k){if(!i[k]){return"noValid"}else{return i[k]}};var g=[trackingContinentPrefix(j)+"_click_domestic",trackingContinentPrefix(j)+"_click_hkmctw",trackingContinentPrefix(j)+"_click_asia",trackingContinentPrefix(j)+"_click_america",trackingContinentPrefix(j)+"_click_europe",trackingContinentPrefix(j)+"_click_oceania"];var c=new daodao.PYPTCityFlyoutOverlay(a,{type:"PYPT_CITY_FLY_OUT",alignElement:ta.id(j),geoIdElement:ta.id(j+"_geo-city"),geoNameElement:ta.id(j),trackingContinent:g,PYPTGeoListPopupType:i[j],onShow:function(){var k=this.options.geoNameElement;if(Type.isElement(k)&&!k.retrieve("typeahead")){k.focus()}},onSelect:function(k,p){var l=this.options,n=l.geoNameElement,m=null,o=null;if(Type.isElement(n)&&(m=n.retrieve("typeahead"))){m.sync({query:p,result:{value:k}})}if(l.PYPTGeoListPopupType){daodao.pageAction(l.PYPTGeoListPopupType+"_geoId_"+k);if(!ta.has("date.picker.pageInDate")&&(o=$$("#hotelSearch .date_picker")[0])){o.getParent().focus()}}}});d.onkeyup=function(){c.hide();ta.id(j+"_geo-city").className=e+"_";d.setAttribute("name","q");$$(".typeahead-container").show()};ta.id(a).onclick=function(){if(!f&&d.value!==""){c.hide()}else{c.show()}f=false};if(h){h.onclick=function(){f=true;daodao.pageAction("PYPT_click_listicon")}}}};
var daodao=daodao||{};daodao.landing={init:function(){this.loadHighResBackdrop()},loadHighResBackdrop:function(){var b=ta.retrieve("homeBackdropHighRes");if(!b){b=$("backdrop").get("lazy-src")}var a=Asset.image(b,{id:"backdrop",onLoad:daodao.landing.showHighResBackdrop});$("backdrop").setProperty("src",a.getProperty("src"))},showHighResBackdrop:function(){new Fx.Tween($("backdrop_blur"),{duration:2000,property:"opacity"}).start(1,0)}};(function(a,c,b){c.maintainableJs=c.maintainableJs||{};c.maintainableJs.themeCollection=["photography","delicacy","shopping","museum","explore"];c.maintainableJs.monthCollection=["jan","feb","mar","apr","may","june","july","aug","sept","oct","nov","dec"];c.maintainableJs.mootab=function(j,h,e,g){var i,d=j.getElements("li"),f=h.getChildren(".tab-body");d.each(function(l,k){l.addEvents({mouseenter:function(m){m.stop();i=setTimeout(function(){d.removeClass("active");d[k].addClass("active");f.removeClass("active");f[k].addClass("active")},250);if(e=="monthTab"){c.maintainableJs.appendMonthContent((k+1),f[k],g)}else{if(e=="themeTab"){c.maintainableJs.appendThemeContent((k+1),f[k],g)}}},mouseleave:function(m){m.stop();clearTimeout(i)}})})};c.maintainableJs.createComparisonFunction=function(d){return function(h,g){var f=h[d];var e=g[d];if(f<e){return -1}else{if(f>e){return 1}else{return 0}}}};c.maintainableJs.getJson=function(e){var d,f=f||[];if(e){for(d in e){f.push(e[d])}f.sort(c.maintainableJs.createComparisonFunction("phoneticName"));return f}return""};c.maintainableJs.getCurrDate=(function(){return{month:new Date().getMonth()}})();c.maintainableJs.getAvailableJson=function(f){var e,d=d||[];if(f){for(e in f){d.push(f[e])}return d}return""};c.maintainableJs.getCurrJson=function(f,e){var d=d||[];e.each(function(h,g){if(f==h.month){d.push(h)}});return d};c.maintainableJs.buildMonthImageUrl=function(d,f){var e=c.maintainableJs.monthCollection[d-1]+"/"+f;return MEDIA_HTTP_BASE+"cms/img/tourism/destination/"+e};c.maintainableJs.buildCurrContent=function(d){var e=e||[];e.push('<ul class="top-destination">');d.each(function(g,f){e.push("<li");if((f+1)%4==0){e.push(' class="flex-layer">')}else{e.push(">")}e.push('<a class="img-wrap scale-up-wrap" target="_blank" href="'+g.geoLocationUrl+'">');e.push('<img class="scale-up-box" alt="'+g.geoLocationName+'" src="'+c.maintainableJs.buildMonthImageUrl(g.month,g.geoPhotoUrl)+'" />');e.push("<span>"+g.geoLocationName+"</span>");if(Browser.ie){e.push('<i class="h-mask" style="width:100%;height:100%;opacity:0.01;"></i>')}e.push("</a>");e.push("</li>")});e.push("</ul>");return e.join("")};c.maintainableJs.appendMonthContent=function(k,e,d){var f=f||[],h="",j=$(e),i=null,g=/^\u52a0\u8f7d\u4e2d/g;if(j.get("text").trim().search(g)!=-1&&d){j.empty();f=c.maintainableJs.getCurrJson(k,d);h=c.maintainableJs.buildCurrContent(f);j.set("html",h);i=j.getElements("i");if(Browser.ie&&i&&i.length){c.maintainableJs.addMaskEffect(i)}}};c.maintainableJs.addMaskEffect=function(d){d.each(function(e,f){e.set("tween",{duration:200});e.addEvents({mouseenter:function(){e.fade(0.3)},mouseleave:function(){e.fade(0.01)}})})};c.maintainableJs.setActive=function(f,e,d){if(e&&d){e.each(function(h,g){if(f==g){$(h).addClass("active");$(d[g]).addClass("active")}})}};c.maintainableJs.getCurrThemeJson=function(d,e){if(!e){return[]}var f=f||[];e.each(function(h,g){if(h.categoryId===d){f.push(h)}});f.sort(c.maintainableJs.createComparisonFunction("rankNumber"));return f};c.maintainableJs.buildThemeImageUrl=function(f,e){var d=c.maintainableJs.themeCollection[f-1]+"/"+e;return MEDIA_HTTP_BASE+"cms/img/tourism/theme_travel/"+d};c.maintainableJs.appendCommonTheme=function(h,d,g,f){var e=e||[];e.push('<li class="theme-'+g+'">');e.push('<a class="scale-up-wrap" target="_blank" href="'+d.geoLocationUrl+'">');e.push('<img class="scale-up-box" src="'+c.maintainableJs.buildThemeImageUrl(d.categoryId,d.cityPhotoUrl)+'" />');e.push("<span>"+d.geoLocationName+f+"</span>");if(Browser.ie){e.push('<i class="h-mask" style="width:100%;height:100%;opacity:0.01;"></i>')}e.push("</a>");e.push("</li>");return e.join("")};c.maintainableJs.appendCurrTheme=function(e,k){var i=0,d=0,j="",l="recommend",f=String.from(e),h=false,g=g||[];switch(f){case"2":j="美食";h=false;i=0;d=4;break;case"3":j="购物";h=false;i=1;d=2;break;case"4":j="博物馆";h=true;i=6;d=2;break;case"5":j="探险";h=true;i=5;d=0;break}if(f==2||f==3){g.push('<ul class="themes themes-left-plus">')}else{if(f==4||f==5){g.push('<ul class="themes themes-left">')}}k.each(function(n,m){if(!h&&m<=1){m==i?l="vertical":l="recommend";g.push(c.maintainableJs.appendCommonTheme(n.categoryId,n,l,j))}else{if(h&&m<=4){m==d?l="horizontal":l="recommend";g.push(c.maintainableJs.appendCommonTheme(n.categoryId,n,l,j))}}});g.push("</ul>");if(f==2||f==3){g.push('<ul class="themes themes-right-plus">')}else{if(f==4||f==5){g.push('<ul class="themes themes-right">')}}k.each(function(n,m){if(!h&&m>1){m==d?l="horizontal":l="recommend";g.push(c.maintainableJs.appendCommonTheme(n.categoryId,n,l,j))}else{if(h&&m>4){m==i?l="vertical":l="recommend";g.push(c.maintainableJs.appendCommonTheme(n.categoryId,n,l,j))}}});g.push("</ul>");return g.join("")};c.maintainableJs.appendThemeContent=function(i,e,d){var g="",h=$(e),f=f||[];if(h.get("data-is-triggered")==="false"&&d){f=c.maintainableJs.getCurrThemeJson(i,d);g=c.maintainableJs.appendCurrTheme(i,f);h.set("html",g);h.set("data-is-triggered",true);maskElemt=h.getElements("i");if(Browser.ie&&maskElemt&&maskElemt.length){c.maintainableJs.addMaskEffect(maskElemt)}}};c.maintainableJs.switchContentLayer=function(){var d=a.innerWidth||document.body.clientWidth||document.documentElement.clientWidth;if(d<=1170){$("tab-body-wrapper").hide();$("tab-body-wrapper-ipad").show()}else{$("tab-body-wrapper-ipad").hide();$("tab-body-wrapper").show()}};a.addEvent("domready",function(){var e=c.maintainableJs.getAvailableJson(JSON.decode($("monthJson").get("html"))),g=c.maintainableJs.getAvailableJson(JSON.decode($("themeJson").get("html"))),f=$$("#tab-monthly-header li"),d=$$("#tab-monthly-wrapper .tab-body");$("tab-body-wrapper").getFirst(".tab-body").addClass("active");$("tab-body-wrapper-ipad").getFirst(".tab-body").addClass("active");c.maintainableJs.switchContentLayer();c.maintainableJs.mootab($("tab-continent-header"),$("tab-body-wrapper"),"continentTab",null);c.maintainableJs.mootab($("tab-continent-header"),$("tab-body-wrapper-ipad"),"continentTab",null);c.maintainableJs.mootab($("tab-monthly-header"),$("tab-monthly-wrapper"),"monthTab",e);c.maintainableJs.mootab($("tab-theme-header"),$("tab-theme-wrapper"),"themeTab",g);c.maintainableJs.setActive(c.maintainableJs.getCurrDate.month,f,d);$("tab-theme-wrapper").getFirst(".tab-body").addClass("active");c.landing.init();ta.run("ta.overlays.Factory.ddPYPTCityFlyout",{},"destinations_lander_loc_handler","destinations_lander_handler_icon","header-search-input search-input","destinations_lander_search_bar_wrap")});a.addEvent("resize",c.maintainableJs.switchContentLayer)})(window,daodao);
var Syncro=(function(){var a=function(){this.components=[]};a.prototype.add=function(b){if(!b.sync||typeof b.sync!=="function"){throw new Error("API Error: component must implement sync(data) function.")}this.components.push(b);this.data&&b.sync(this.data)};a.prototype.sync=function(b,d){this.data=d;for(var c=this.components.length-1;c>=0;c--){this.components[c]!==b&&this.components[c].sync(d)}};return a}());
(function(){if(typeof ta.pages=="undefined"){ta.pages={}}if(typeof ta.pages.home=="undefined"){ta.pages.home={}}daodao=daodao||{};daodao.home=daodao.home||{};daodao.home.createTypeAhead=function(m,g,h,k,n,l){m&&m.stop();g.removePropertyEvent("focus","daodao.home.createTypeAhead");var e=b(k);if(l){d(e)}var j={hotel:"h",eat:"e",attr:"A",dest:"g"};var f={minChars:3,offsetY:-1,defaultTextClass:"focusClear",syncro:null,search:function(p){var o=ta.util.Deferred();new ta.util.ajax({url:"/TypeAheadJson",data:{action:h,startTime:ta.pages.home.ptptFirstInteractionStamp,uiOrigin:e,types:"geo"+(k?","+k:""),hglt:"true",global:"true",query:p,legacy_format:"true",_ignoreMinCount:"true"}}).always(function(q){if(q&&q.length){o.resolve(q)}else{o.reject(JS_location_not_found)}});return o.promise()},listTemplate:function(q){var r=['<div class="typeahead-choices">'];var o=ta.retrieve("x.gif")||"/img2/x.gif";var p={};q.results.push({coords:q.results[0].coords,index:1,name:g.retrieve("typeahead").query,rendered:"查找更多关于 <b>"+g.retrieve("typeahead").query+"</b> 的搜索结果",title:"搜索",type:"SEARCH",url:"/Search?where=nav&returnTo=__2F__&q="+g.retrieve("typeahead").query+"&geo=&ssrc="+j[k],value:q.results[0].value});Array.each(q.results,function(s){var t=[];t.push('<div class="typeahead-choice" ');if(s.type&&!p[s.type]){p[s.type]=true;t.push(">");var u=[];u.push("<div class='typeahead-title'>");u.push(s.title);u.push("<img class="+s.type.toLowerCase()+" src='"+o+"'>");u.push("</div>");t=u.concat(t)}else{t.push(">")}t.push(s.rendered);t.push("</div>");r=r.concat(t)});r.push("</div>");return r.join("")},itemTemplate:function(o){if("eat"===k&&o.address&&o.address.length){return o.name+'<div class="address">'+o.address+"</div>"}return o.name},assumeOnBlur:function(q){for(var p=0,o=q.results.length;p<o;p++){if(q.options.resolveSelection(q.results[p]).toLowerCase().indexOf(q.query.toLowerCase())>=0){return p}}return 0},showOnFocus:(Browser.ie&&Browser.version<=8)?false:true,onUserFocus:function(o){d(k);if(Browser.ie6||Browser.ie7||Browser.ie8){a(o)}if(ta.retrieve("typeahead.isFromDDPYPTCityFlyout")){o.results=null;o.query=null;ta.store("typeahead.isFromDDPYPTCityFlyout",false)}},onSelect:function(o,r,s){var q=function(){if(m||window.event){new Event(m||window.event).stop()}var u=o.url;if("SEARCH"===o.type){u=o.url}else{if("hotel"===k){if(ta.has("useHotelsFilterState")){if("GEO"==o.type){var w="geo="+o.value;var v="&"+w;ta.pages.home.updateStateAndRedirect(v);return false}else{var u="/Hotel_Review-d"+o.value;var v="&clear=true";var t=ta.widgets.calendar.getCheckRatesData();if(t){v="&"+Object.toQueryString(t)}ta.widgets.calendar.updateSessionDates(u,v);return false}}else{u="/HACSearch?"+("GEO"===o.type?"geo":"detail")+"="+o.value}}else{if("eat"===k){if("GEO"===o.type){u="/Restaurants?geo="+o.value}}else{if("attr"===k){if("GEO"===o.type){u="/Attractions?geo="+o.value}}else{if("vr"===k){var t=ta.widgets.calendar.getCheckRatesData();if(t){u="/VRACSearch?"+("GEO"===o.type?"geo":"detail")+"="+o.value;u=u+"&"+Object.toQueryString(t)}}}}}}location.hash=s.query+";"+o.value;if("hotel"===k){setPID("35903")}else{if("attr"===k){setPID("35904")}else{if("eat"===k){setPID("35905")}else{if("geo"===k){setPID("35907")}}}}daodao.pageAction("Daodao_PTPT_Submit");window.location=u};if(daodao.home.isAutoSubmit){daodao.home.isAutoSubmit=false;q()}var p=s.results?s.results.length:0;ta.pages.home.logAndAct("select","PTPT-"+k,o.type,"PTPT",s.selectedIndex+1,p,o.value,null);g.store("redir",q)},shouldSubmit:function(){if(ta.id("PTPT_HAC_FORM")){return false}return true},onRestore:function(o){g.form.eliminate("redir")},onSync:function(q,p,o){g.removeClass("focusClear")},onRender:c,onError:c,resolveSelection:function(o){return o.name.stripTags()},onSelectNavigate:function(){if(this.results[this.selectedIndex].type=="SEARCH"){g.retrieve("redir")()}},validator:ta.pages.home.validate.partial(null,g.form)};f.autopopulateHighlighted=false;f.autoHighlightFirst=true;f.ignoreKeysWhenInvisible=true;f.nextField=function(p){var o=g.getParent("form").getElement(".date_picker");if((Browser.ie6||Browser.ie7||Browser.ie8)&&o){return o&&o.getParent()}else{if(o&&Date.parse(o.innerHTML)=="Invalid Date"&&ta.has("isDaoDaoHomePageUnforkCalendar")){return o&&o.getParent()}else{return p&&p.source}}};var i=new TypeAhead(g,api.extend(f,n));g.store("typeahead",i);return i};ta.pages.home.updateStateAndRedirect=function(e){new Request({url:"/FilterState",data:e,method:"post",onSuccess:function(f){ta.widgets.calendar.redirectToHotelOverview(f)},onFailure:function(f){ta.widgets.calendar.redirectToHotelOverview(null)}}).send()};ta.queueForLoad(function(){var j=location.hash.slice(1).split(";"),h=j&&j.shift(),g=j&&j.shift(),f=ta.id("hotelSearch"),i=f&&f.getElement("input.search-input"),e=ta.pages.home.searchSyncro||(ta.pages.home.searchSyncro=new Syncro());if(!(h&&g)){return}e.sync(null,{query:h,value:h,result:{value:g}});if(i){i.focus();i.blur()}});ta.pages.home.getInputField=function(e){return e.getElement("input[name='q']")};ta.pages.home.getUIOrignForForm=function(e){switch(e.id){case"attractionSearch":return"PTPT-attr";case"destinationSearch":return"PTPT-dest";case"hotelSearch":return"PTPT-hotel";case"restaurantSearch":return"PTPT-eat";default:return undefined}};ta.pages.home.trackFindEvent=function(f,l,j){var h=ta.pages.home.getInputField(f);var g=h&&h.retrieve("typeahead");if(g){var i=ta.pages.home.getUIOrignForForm(f);l=l||"";var k=g&&h.value.trim().length>0&&h.value!==h.defaultValue;if(!ta.retrieve("typeahead.revised.pypt.mechanics.feature")){if(k){if(g.options.minChars>h.value.length){l="not_enough_chars;"+l}else{if(g.selectedIndex<0){l="no_selection;"+l}}}else{l="blank;"+l}}else{if(k&&ta.retrieve("typeahead_pypt_allow_too_few_chars_search_feature")&&g.options.minChars>h.value.length){l="low_chars_search;"+l}}var e=ta.pages.home.getFindLastUserInteractionType();ta.pages.home.logAndAct("find",i,"","PTPT",0,0,"",j,e,l)}else{if(j){j()}}};ta.pages.home.getFindLastUserInteractionType=function(){var e=ta.retrieve("ta.pages.home.find.clicked")?"click":"enter";ta.remove("ta.pages.home.find.clicked");return e};ta.pages.home.validate=function(j,g){var i=g.getElement("input.search-input"),f=false,h=i.retrieve("typeahead"),e=i.retrieve("redir");if(!i.value.length||i.value===i.defaultValue){i.focus();if(h){h.renderError(JS_location_not_found);h.show()}}else{if(h&&!h.results){daodao.pageAction("Daodao_PTPT_Submit");g.submit()}else{if(Type.isFunction(e)){e()}else{f=true}}}ta.pages.home.trackFindEvent(g,null,null);if(!f&&(j||window.event)){new Event(j||window.event).stop()}return f};function c(f,e){if(f.query){var g=ta.retrieve("typeahead.results");if(!g){g={}}g[f.query]=true;ta.store("typeahead.results",g)}}ta.pages.home.logAndAct=function(f,e,p,k,o,m,h,l,j,n,i){var g={uiOrigin:e,global:true,type:p,query:i,value:h,eventType:f,source:k,startTime:ta.pages.home.ptptFirstInteractionStamp,action:"RECORD",selDepth:o,totalNum:m,userInteractionType:j,errors:n};(function(){new Request({method:"GET",url:"/TypeAheadJson",data:g,onSuccess:l,onFailure:l}).send()}).delay(10)};var d=function(f){if(!ta.pages.home.ptptFirstInteractionStamp){var e=new Date();ta.pages.home.ptptFirstInteractionStamp=e.getTime()+(e.getTimezoneOffset()*60*1000);ta.pages.home.logAndAct("start",f,"","PTPT",0,0,"",null)}};var b=function(e){if(e){return"PTPT-"+e}else{return"unknown"}};var a=function(e){if(e&&e.source){var f=e.source.value;e.source.value="";e.source.value=f}}})();
(function(g){var a,e,h=null;function b(){return(a.getWidth()-e)>0}function c(){clearTimeout(h);h=null;if(b()){if(!a.hasClass("greater-bg-width")){a.addClass("greater-bg-width")}}else{if(a.hasClass("greater-bg-width")){a.removeClass("greater-bg-width")}}}function d(){if(h==null){h=setTimeout(c,200)}}function f(){if(!Browser.ie||Browser.version>8){return false}a=$("headerScrollLimiter");if(!a){return false}e=Number.from(a.get("data-backdrop-width"));if(!e){return false}if(b()){c()}window.addEvent("resize",d)}window.addEvent("domready",f)})();
(function(c,e){var d={scaleImages:$$(".scale-up-box"),browserName:Browser.name,browserVersion:Browser.version};var b=function(){d.scaleImages.getParent().each(function(g,f){new Element("i",{styles:{width:g.getParent().getStyle("width").toInt(),height:g.getParent().getStyle("height").toInt(),"line-height":g.getParent().getStyle("height").toInt(),opacity:"0.01"},"class":"h-mask",tween:{duration:200}}).inject(g);g.getChildren("i").each(function(h,i){h.addEvents({mouseenter:function(){h.fade(0.3)},mouseleave:function(){h.fade(0.01)}})})})};var a=function(){d.scaleImages.getParent().each(function(g,f){if(g.getChildren("i").length>0){g.getChildren("i").setStyles({width:g.getParent().getStyle("width").toInt(),height:g.getParent().getStyle("height").toInt(),"line-height":g.getParent().getStyle("height").toInt()})}})};c.addEvent("domready",function(){if(d.browserName==="ie"&&d.scaleImages.length>0){b()}});c.addEvent("resize",function(){if(d.browserName==="ie"&&d.scaleImages.length>0){a()}})})(window);
